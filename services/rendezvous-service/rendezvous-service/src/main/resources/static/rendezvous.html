<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Rendez-vous - H√¥pital</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #3498db; padding-bottom: 15px; }
        .user-info { background: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2980b9; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .appointment-list { max-height: 400px; overflow-y: auto; }
        .appointment-item { padding: 10px; border: 1px solid #eee; margin: 5px 0; border-radius: 4px; background: #f9f9f9; }
        .error { color: #e74c3c; background: #fadbd8; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: #27ae60; background: #d5f4e6; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .loading { color: #3498db; text-align: center; padding: 10px; }
        .warning { color: #f39c12; background: #fef5e7; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Gestion des Rendez-vous SOAP</h1>
            <div>
                <button class="btn" onclick="testConnection()">Tester Connexion SOAP</button>
                <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div class="user-info">
            <h3>Informations Utilisateur</h3>
            <div id="userDetails">
                <!-- Les informations seront charg√©es dynamiquement -->
            </div>
        </div>

        <!-- Section Test de Connexion -->
        <div class="section">
            <h2>üîó Test de Connexion SOAP</h2>
            <button class="btn" onclick="testConnection()">Tester la connexion au service</button>
            <div id="testResult"></div>
        </div>

        <!-- Section Cr√©ation de Rendez-vous -->
        <div class="section">
            <h2>üìÖ Nouveau Rendez-vous</h2>
            <form id="createAppointmentForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="patientId">ID Patient:</label>
                        <input type="text" id="patientId" name="patientId" required placeholder="ex: PAT001">
                    </div>
                    <div class="form-group">
                        <label for="doctorId">ID Docteur:</label>
                        <input type="number" id="doctorId" name="doctorId" required placeholder="ex: 1" min="1">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="appointmentDate">Date:</label>
                        <input type="date" id="appointmentDate" name="appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="appointmentTime">Heure:</label>
                        <input type="time" id="appointmentTime" name="appointmentTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="appointmentType">Type de rendez-vous:</label>
                    <select id="appointmentType" name="appointmentType" required>
                        <option value="">S√©lectionnez un type</option>
                        <option value="CONSULTATION">Consultation</option>
                        <option value="URGENCE">Urgence</option>
                        <option value="CONTROLE">Contr√¥le</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reason">Raison/Motif:</label>
                    <textarea id="reason" name="reason" rows="3" required placeholder="D√©crivez la raison de la consultation..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">Cr√©er Rendez-vous</button>
            </form>
            <div id="createResult"></div>
        </div>

        <!-- Section Recherche de Rendez-vous -->
        <div class="section">
            <h2>üîç Rechercher Rendez-vous par Patient</h2>
            <div style="display: flex; gap: 10px; align-items: end;">
                <div class="form-group" style="flex: 1;">
                    <label for="searchPatientId">ID Patient:</label>
                    <input type="text" id="searchPatientId" name="searchPatientId" placeholder="ex: PAT001">
                </div>
                <button class="btn" onclick="searchAppointments()">Rechercher</button>
            </div>
            <div id="searchResult" class="appointment-list"></div>
        </div>

        <!-- Section Annulation de Rendez-vous -->
        <div class="section">
            <h2>‚ùå Annuler un Rendez-vous</h2>
            <div style="display: flex; gap: 10px; align-items: end;">
                <div class="form-group" style="flex: 1;">
                    <label for="cancelAppointmentId">ID Rendez-vous:</label>
                    <input type="number" id="cancelAppointmentId" name="cancelAppointmentId" placeholder="ex: 1" min="1">
                </div>
                <button class="btn btn-danger" onclick="cancelAppointment()">Annuler Rendez-vous</button>
            </div>
            <div id="cancelResult"></div>
        </div>

        <!-- Section D√©tails Rendez-vous -->
        <div class="section">
            <h2>üìã D√©tails d'un Rendez-vous</h2>
            <div style="display: flex; gap: 10px; align-items: end;">
                <div class="form-group" style="flex: 1;">
                    <label for="detailsAppointmentId">ID Rendez-vous:</label>
                    <input type="number" id="detailsAppointmentId" name="detailsAppointmentId" placeholder="ex: 1" min="1">
                </div>
                <button class="btn" onclick="getAppointmentDetails()">Voir D√©tails</button>
            </div>
            <div id="detailsResult"></div>
        </div>
    </div>

    <script>
        // CORRECTION : URL du service SOAP - utiliser l'URL relative
        const SOAP_URL = '/services/RendezvousService';
        
        // V√©rifier l'authentification au chargement
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setTodayDate();
            console.log('üöÄ Application Rendez-vous SOAP initialis√©e');
        });

        // V√©rifier si l'utilisateur est authentifi√©
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                document.getElementById('userDetails').innerHTML = `
                    <div class="warning">
                        <p><strong>‚ö†Ô∏è Non authentifi√©</strong></p>
                        <p>Veuillez vous connecter d'abord sur le service d'authentification.</p>
                        <button class="btn" onclick="redirectToLogin()">Se connecter</button>
                    </div>
                `;
            } else {
                document.getElementById('userDetails').innerHTML = `
                    <p><strong>Email:</strong> ${user.email || 'Non disponible'}</p>
                    <p><strong>R√¥le:</strong> ${user.role || 'Non disponible'}</p>
                    <p><strong>Service:</strong> Gestion des Rendez-vous SOAP</p>
                    <p><small>Token JWT pr√©sent - Acc√®s autoris√©</small></p>
                `;
            }
        }

        function redirectToLogin() {
            window.location.href = 'http://localhost:8081/login.html';
        }

        // Fonctions SOAP
        async function testConnection() {
            try {
                showLoading('testResult', 'Test de connexion en cours...');
                const response = await sendSoapRequest('testConnection');
                document.getElementById('testResult').innerHTML = 
                    `<div class="success">‚úÖ ${response}</div>`;
            } catch (error) {
                document.getElementById('testResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Gestion du formulaire de cr√©ation
        document.getElementById('createAppointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            
            if (!date || !time) {
                document.getElementById('createResult').innerHTML = 
                    `<div class="error">‚ùå Veuillez s√©lectionner une date et une heure</div>`;
                return;
            }

            const formData = {
                patientId: document.getElementById('patientId').value,
                doctorId: parseInt(document.getElementById('doctorId').value),
                dateTime: `${date}T${time}:00`,
                type: document.getElementById('appointmentType').value,
                reason: document.getElementById('reason').value
            };

            try {
                showLoading('createResult', 'Cr√©ation du rendez-vous en cours...');
                const response = await sendSoapRequest('createAppointment', formData);
                
                document.getElementById('createResult').innerHTML = 
                    `<div class="success">‚úÖ ${response}</div>`;
                
                // R√©initialiser le formulaire
                this.reset();
                // Remettre la date du jour
                setTodayDate();
            } catch (error) {
                document.getElementById('createResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        });

        async function searchAppointments() {
            const patientId = document.getElementById('searchPatientId').value;
            if (!patientId) {
                alert('Veuillez entrer un ID patient');
                return;
            }

            try {
                showLoading('searchResult', 'Recherche des rendez-vous en cours...');
                const response = await sendSoapRequest('listAppointmentsByPatient', { patientId });
                
                const resultDiv = document.getElementById('searchResult');
                
                if (Array.isArray(response)) {
                    if (response.length > 0) {
                        resultDiv.innerHTML = '<h4>Rendez-vous trouv√©s:</h4>' + 
                            response.map(app => 
                                `<div class="appointment-item">üìÖ ${app}</div>`
                            ).join('');
                    } else {
                        resultDiv.innerHTML = '<div class="appointment-item">‚ÑπÔ∏è Aucun rendez-vous trouv√© pour ce patient</div>';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="appointment-item">${response}</div>`;
                }
            } catch (error) {
                document.getElementById('searchResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function cancelAppointment() {
            const appointmentId = document.getElementById('cancelAppointmentId').value;
            if (!appointmentId) {
                alert('Veuillez entrer un ID de rendez-vous');
                return;
            }

            try {
                showLoading('cancelResult', 'Annulation du rendez-vous en cours...');
                const response = await sendSoapRequest('cancelAppointment', { appointmentId: parseInt(appointmentId) });
                
                const message = response === 'true' || response === true ? 
                    'annul√© avec succ√®s' : 'non trouv√© ou d√©j√† annul√©';
                
                document.getElementById('cancelResult').innerHTML = 
                    `<div class="success">‚úÖ Rendez-vous ${appointmentId} ${message}</div>`;
                
                document.getElementById('cancelAppointmentId').value = '';
            } catch (error) {
                document.getElementById('cancelResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function getAppointmentDetails() {
            const appointmentId = document.getElementById('detailsAppointmentId').value;
            if (!appointmentId) {
                alert('Veuillez entrer un ID de rendez-vous');
                return;
            }

            try {
                showLoading('detailsResult', 'R√©cup√©ration des d√©tails...');
                const response = await sendSoapRequest('getAppointmentDetails', { appointmentId: parseInt(appointmentId) });
                
                document.getElementById('detailsResult').innerHTML = 
                    `<div class="appointment-item">üìã ${response}</div>`;
                
            } catch (error) {
                document.getElementById('detailsResult').innerHTML = 
                    `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // FONCTION MODIFI√âE : Envoi des requ√™tes SOAP AVEC TOKEN JWT
        async function sendSoapRequest(operation, params = {}) {
            // R√©cup√©rer le token JWT du localStorage
            const token = localStorage.getItem('token');
            
            if (!token) {
                throw new Error('Token JWT manquant. Veuillez vous connecter d\'abord.');
            }

            let soapBody = '';
            
            if (operation === 'testConnection') {
                soapBody = `<urn:testConnection/>`;
            }
            else if (operation === 'createAppointment') {
                soapBody = `
                    <urn:createAppointment>
                        <patientId>${params.patientId}</patientId>
                        <doctorId>${params.doctorId}</doctorId>
                        <dateTime>${params.dateTime}</dateTime>
                        <type>${params.type}</type>
                        <reason>${params.reason}</reason>
                    </urn:createAppointment>
                `;
            } else if (operation === 'cancelAppointment') {
                soapBody = `
                    <urn:cancelAppointment>
                        <appointmentId>${params.appointmentId}</appointmentId>
                    </urn:cancelAppointment>
                `;
            } else if (operation === 'listAppointmentsByPatient') {
                soapBody = `
                    <urn:listAppointmentsByPatient>
                        <patientId>${params.patientId}</patientId>
                    </urn:listAppointmentsByPatient>
                `;
            } else if (operation === 'getAppointmentDetails') {
                soapBody = `
                    <urn:getAppointmentDetails>
                        <appointmentId>${params.appointmentId}</appointmentId>
                    </urn:getAppointmentDetails>
                `;
            }

            // REQU√äTE SOAP MODIFI√âE : Ajout du header Authorization avec le token JWT
            const soapRequest = `<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:urn="http://hospital.com/rendezvous">
    <soap:Header>
        <Authorization xmlns="http://hospital.com/security">Bearer ${token}</Authorization>
    </soap:Header>
    <soap:Body>
        ${soapBody}
    </soap:Body>
</soap:Envelope>`;

            console.log(`Envoi SOAP ${operation} avec token JWT`);

            try {
                const response = await fetch(SOAP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/xml; charset=utf-8',
                        'SOAPAction': ''
                    },
                    body: soapRequest
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur HTTP d√©taill√©e:', errorText);
                    
                    // Essayer d'extraire le message d'erreur SOAP
                    if (response.status === 500) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(errorText, 'text/xml');
                        const fault = xmlDoc.getElementsByTagName('faultstring')[0];
                        if (fault) {
                            const faultMessage = fault.textContent;
                            if (faultMessage.includes('Token') || faultMessage.includes('JWT') || faultMessage.includes('authentification')) {
                                throw new Error('Erreur d\'authentification: ' + faultMessage);
                            }
                            throw new Error(faultMessage);
                        }
                    }
                    
                    throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
                }

                const responseText = await response.text();
                console.log(`R√©ponse SOAP ${operation}:`, responseText);
                return parseSoapResponse(responseText, operation);
            } catch (error) {
                console.error('Erreur fetch:', error);
                
                // V√©rifier si c'est une erreur d'authentification
                if (error.message.includes('Token') || error.message.includes('JWT') || error.message.includes('authentification')) {
                    // Token invalide ou expir√©
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    checkAuthentication(); // Mettre √† jour l'interface
                    throw new Error('Session expir√©e. Veuillez vous reconnecter.');
                }
                
                throw new Error('Impossible de contacter le service SOAP. V√©rifiez que le service est d√©marr√© sur le port 8083.');
            }
        }

        // Parser la r√©ponse SOAP
        function parseSoapResponse(xmlResponse, operation) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlResponse, 'text/xml');
                
                const fault = xmlDoc.getElementsByTagName('soap:Fault')[0] || 
                             xmlDoc.getElementsByTagName('faultstring')[0];
                
                if (fault) {
                    const faultString = xmlDoc.getElementsByTagName('faultstring')[0];
                    throw new Error(faultString ? faultString.textContent : 'Erreur SOAP inconnue');
                }

                if (operation === 'listAppointmentsByPatient') {
                    return parseListAppointmentsResponse(xmlDoc);
                }

                const responseElement = xmlDoc.getElementsByTagName(`${operation}Response`)[0];
                if (responseElement) {
                    const returnElements = responseElement.getElementsByTagName('return');
                    if (returnElements.length > 0) {
                        return returnElements[0].textContent;
                    }
                }

                const anyReturn = xmlDoc.getElementsByTagName('return')[0];
                if (anyReturn) {
                    return anyReturn.textContent;
                }

                return 'R√©ponse sans contenu';

            } catch (error) {
                console.error('Erreur parsing SOAP:', error);
                throw error;
            }
        }

        function parseListAppointmentsResponse(xmlDoc) {
            const results = [];
            
            const responseElement = xmlDoc.getElementsByTagName('listAppointmentsByPatientResponse')[0];
            if (responseElement) {
                const returnElements = responseElement.getElementsByTagName('return');
                for (let i = 0; i < returnElements.length; i++) {
                    results.push(returnElements[i].textContent);
                }
            }
            
            if (results.length === 0) {
                const allReturnElements = xmlDoc.getElementsByTagName('return');
                for (let i = 0; i < allReturnElements.length; i++) {
                    const text = allReturnElements[i].textContent;
                    if (text && text.trim() !== '') {
                        results.push(text);
                    }
                }
            }
            
            return results.length > 0 ? results : ['Aucun rendez-vous trouv√©'];
        }

        function showLoading(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="loading">‚è≥ ${message}</div>`;
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'http://localhost:8081/login.html';
        }

        function setTodayDate() {
            const today = new Date();
            document.getElementById('appointmentDate').valueAsDate = today;
        }
    </script>
</body>
</html>